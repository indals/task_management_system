name: Deploy Flask to EC2

on:
  push:
    branches: [ master ]   # Trigger when pushing to master branch

jobs:
  deploy:
    name: Deploy Flask App
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Add SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_KEY }}" > ~/.ssh/task_managment_system_key_pair.pem
        chmod 600 ~/.ssh/task_managment_system_key_pair.pem
        ssh-keyscan -H 65.2.186.248 >> ~/.ssh/known_hosts

    - name: Copy files to EC2
      run: |
        rsync -avz -e "ssh -i ~/.ssh/task_managment_system_key_pair.pem" . ubuntu@65.2.186.248:/home/ubuntu/taskmanager

    - name: Deploy with Docker Compose
      run: |
        ssh -i ~/.ssh/task_managment_system_key_pair.pem ubuntu@65.2.186.248 << 'EOF'
          set -e
          cd /home/ubuntu/taskmanager

          # Install Docker and docker-compose if missing
          sudo apt-get update -y
          sudo apt-get install -y docker.io docker-compose

          # Stop old containers (if any) and clean up
          sudo docker-compose -f docker/docker-compose.yml down || true

          # Build and start new containers
          sudo docker-compose -f docker/docker-compose.yml up -d --build

          # Show running containers
          sudo docker ps
        EOF

    - name: Verify Deployment
      run: |
        ssh -i ~/.ssh/task_managment_system_key_pair.pem ubuntu@65.2.186.248 << 'EOF'
          sleep 10
          if sudo docker ps | grep -q "taskmanager_app"; then
            echo "âœ… Flask + Redis are running in Docker"
            sudo docker logs taskmanager_app --tail=20
          else
            echo "âŒ Deployment failed"
            exit 1
          fi
        EOF

    - name: Notify Deployment Success
      run: |
        echo "ðŸš€ Deployment successful!"
        echo "App should be accessible at: http://65.2.186.248:5000"
